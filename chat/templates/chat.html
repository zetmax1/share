{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chatting with {{ username }}</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" />
  <link rel="stylesheet" href="{% static 'styles/chat.css' %}">
</head>
<body>
  <div class="container-fluid h-100" data-theme="light">
    <div class="row h-100">
      <!-- User List Sidebar (4 Columns) -->
      <div class="col-3 sidebar p-3 chats">
        <h5 class="mb-3">
          <a href="{% url 'home' %}" class="btn btn-outline-secondary mr-2">
            <i class="fas fa-home"></i> ShareWisdom
          </a>
          Chats
        </h5>
       
        <div class="contacts">
          {% for item in user_last_messages %}
          <a href="{% url 'chat' item.user.username %}"
            class="list-group-item list-group-item-action {% if item.user.username == username %} active {% endif %}"
            data-id="{{ username }}">
            <div class="d-flex align-items-center">
              <img src="{{ item.user.avatar.url|default:'/static/default-avatar.png' }}" alt="{{ item.user.username }}'s Profile Image"
                class="profile-icon rounded-circle mr-3" />
              <div class="w-100">
                <div class="d-flex justify-content-between">
                  <strong class="text-truncate">{{ item.user.username }}</strong>
                  {% if item.last_message %}
                  {% load tz %}
                  <small class="text-nowrap timestamp">
                    {% if item.last_message.timestamp|date:"Y-m-d" == "now"|date:"Y-m-d" %}
                      {{ item.last_message.timestamp|localtime|date:"H:i" }}
                    {% else %}
                      {{ item.last_message.timestamp|localtime|date:"d.m.Y" }}
                    {% endif %}
                  </small>
                  {% else %}
                  <small class="text-nowrap timestamp"></small>
                  {% endif %}
                </div>
                <div>
                  {% if item.last_message %}
                  <small class="d-block text-truncate last-msg" id="last-message">
                    {% if item.last_message.sender == request.user %} You: {% endif %}
                    {{ item.last_message.content|truncatewords:5 }}
                  </small>
                  {% else %}
                  <small class="d-block text-truncate last-msg" id="last-message">No messages yet</small>
                  {% endif %}
                </div>
              </div>
            </div>
          </a>
          {% endfor %}
        </div>
        <div class="logout">
          <h5>
            <i class="fas fa-user"></i>
            {{ request.user.username }}
          </h5>
        </div>
      </div>

      <!-- Chat Area (8 Columns) -->
      <div class="col-9 d-flex flex-column chat" data-id="{{ username }}">
        <div class="d-flex align-items-center p-1 header-bar">
          
          <img src="{{ selected_user.avatar.url|default:'/static/default-avatar.png' }}" style="border-radius: 50%; height: 45px; width: 50px" />
          <h3 class="display-5 mb-0" style="padding-left: 10px;"><a href="{% url 'user-profile' selected_user.id %}">{{ username }}</a></h3>
          <div class="ml-auto d-flex align-items-center">
            <form method="GET" action="" class="position-relative">
              <div class="form-group mb-0 d-flex align-items-center">
                <input type="text" name="search" id="searchInput" class="form-control" placeholder="Search messages..."
                  value="{{ search_query }}" onkeyup="searchMessages()" style="width: 200px;" />
                <button id="theme-toggle" class="btn btn-outline-secondary ml-2">
                  <i class="fas fa-moon"></i>
                </button>
                <div id="searchResults" class="search-results" style="display: none;"></div>
              </div>
            </form>
          </div>
        </div>
        <div id="chatbox" class="chatbox flex-fill p-3">
          {% if chats %}
          {% for message in chats %}
          {% if not message.is_deleted %}
          <div class="chat-message {% if message.sender == request.user %} sender {% else %} receiver {% endif %}"
            id="message-{{ message.id }}"
            data-reply-to-content="{% if message.reply_to %}{{ message.reply_to.content|escapejs }}{% endif %}"
            data-previous-content="{% if message.previous_content %}{{ message.previous_content|escapejs }}{% endif %}">
            <div class="message-content">
              {% if message.content %}
              <span>{{ message.content }}</span>
              {% elif message.image %}
              <img src="{{ message.image.url }}" style="max-width: 200px;" />
              {% elif message.video %}
              <video controls style="max-width: 200px;"><source src="{{ message.video.url }}"></video>
              {% elif message.voice %}
              <audio controls><source src="{{ message.voice.url }}"></audio>
              {% elif message.file %}
              <a href="{{ message.file.url }}" target="_blank">{{ message.file.name }}</a>
              {% endif %}
              {% if message.edited %}
              <small>(edited)</small>
              {% endif %}
              {% if message.reply_to %}
              <small>(reply to "{{ message.reply_to.content|truncatewords:3 }}")</small>
              {% endif %}
            </div>
            <div class="actions">
              <i class="fas fa-ellipsis-v" onclick="toggleDropdown('{{ message.id }}')"></i>
              <div class="dropdown-menu" id="dropdown-{{ message.id }}" style="display: none;">
                {% if message.sender == request.user %}
                <div class="dropdown-item" onclick="editMessage('{{ message.id }}')">Edit</div>
                <div class="dropdown-item delete" onclick="deleteMessage('{{ message.id }}')">Delete</div>
                {% endif %}
                <div class="dropdown-item" onclick="replyToMessage('{{ message.id }}')">Reply</div>
                <div class="dropdown-item" onclick="copyMessage('{{ message.content|escapejs }}')">Copy</div>
              </div>
            </div>
          </div>
          {% endif %}
          {% endfor %}
          {% else %}
          <p class="no-messages">No Messages.</p>
          {% endif %}
        </div>
        <div class="chat-input p-3">
          <div class="input-group d-flex align-items-center">
            <div class="input-group-prepend">
              <label class="btn btn-outline-secondary m-0" style="cursor: pointer;">
                <i class="fas fa-paperclip"></i>
                <input type="file" id="mediaInput" style="display: none;" accept="image/*,video/*,audio/*,.*" multiple>
              </label>
              <button id="voiceButton" class="btn btn-outline-secondary m-0" type="button">
                <i class="fas fa-microphone"></i>
              </button>
            </div>
            <input type="text" id="my_input" class="form-control mx-2" placeholder="Type a message..." required />
            <div class="input-group-append">
              <button id="submit_button" class="btn btn-primary m-0" type="button">Send</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {{ username|json_script:"room_slug" }}
  {{ chats_serialized|json_script:"chat_messages" }}

  <script>
    const chatbox = document.querySelector("#chatbox");
    function scrollToBottom() {
      chatbox.scrollTop = chatbox.scrollHeight;
    }
    scrollToBottom();

    const roomName = JSON.parse(document.getElementById("room_slug").textContent);
    const wsProtocol = window.location.protocol === "https:" ? "wss://" : "ws://";
    const wsHost = window.location.host || "localhost:8000";
    const chatSocket = new WebSocket(`${wsProtocol}${wsHost}/ws/chat/${roomName}/`);

    chatSocket.onopen = function (e) {
      console.log("WebSocket connected successfully");
    };
    chatSocket.onerror = function (e) {
      console.error("WebSocket error:", e);
    };
    chatSocket.onclose = function (e) {
      console.log("WebSocket closed:", e);
    };

    window.onbeforeunload = function() {
      chatSocket.close();
    };

    document.querySelector("#my_input").focus();
    document.querySelector("#my_input").onkeyup = function (e) {
      if (e.keyCode === 13) {
        e.preventDefault();
        document.querySelector("#submit_button").click();
      }
    };

    document.querySelector("#submit_button").onclick = function (e) {
      const messageInput = document.querySelector("#my_input").value;
      if (!messageInput) {
        alert("Please enter a message!");
        return;
      }
      console.log("Sending message:", messageInput);
      chatSocket.send(JSON.stringify({
        action: "send",
        message: messageInput
      }));
      document.querySelector("#my_input").value = "";
    };

    document.querySelector("#mediaInput").addEventListener("change", function (e) {
      const files = e.target.files;
      if (files.length > 0) {
        for (let file of files) {
          const formData = new FormData();
          formData.append("file", file);
          formData.append("action", "media");
          formData.append("type", file.type.startsWith("image/") ? "image" :
                                 file.type.startsWith("video/") ? "video" :
                                 file.type.startsWith("audio/") ? "voice" : "file");

          fetch("/upload-media/", {
            method: "POST",
            body: formData,
            headers: { "X-CSRFToken": getCookie("csrftoken") }
          })
          .then(response => {
            if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
            return response.json();
          })
          .then(data => {
            console.log("File uploaded:", data);
            chatSocket.send(JSON.stringify({
              action: "media",
              type: data.type,
              url: data.url,
              filename: file.name
            }));
          })
          .catch(error => {
            console.error("Error uploading file:", error);
            alert("Failed to upload file.");
          });
        }
      }
    });

    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + "=")) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    let mediaRecorder;
    let audioChunks = [];
    document.querySelector("#voiceButton").addEventListener("click", async function () {
      if (!mediaRecorder || mediaRecorder.state === "inactive") {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorder = new MediaRecorder(stream);
          mediaRecorder.start();
          this.innerHTML = '<i class="fas fa-stop"></i>';
          this.classList.add("recording");

          mediaRecorder.ondataavailable = (event) => audioChunks.push(event.data);
          mediaRecorder.onstop = () => {
            this.classList.remove("recording");
            const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
            audioChunks = [];

            const formData = new FormData();
            formData.append("file", audioBlob, "voice-message.webm");
            formData.append("action", "media");
            formData.append("type", "voice");

            fetch("/upload-media/", {
              method: "POST",
              body: formData,
              headers: { "X-CSRFToken": getCookie("csrftoken") }
            })
            .then(response => {
              if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
              return response.json();
            })
            .then(data => {
              chatSocket.send(JSON.stringify({
                action: "media",
                type: "voice",
                url: data.url,
                filename: "voice-message.webm"
              }));
            })
            .catch(error => {
              console.error("Error uploading voice:", error);
              alert("Failed to upload voice message.");
            });
          };
        } catch (err) {
          console.error("Microphone access error:", err);
          alert("Please allow microphone access.");
        }
      } else {
        mediaRecorder.stop();
        this.innerHTML = '<i class="fas fa-microphone"></i>';
      }
    });

    chatSocket.onmessage = function (e) {
      const data = JSON.parse(e.data);
      console.log("Received WebSocket message:", data);

      if (data.action === "send" || data.action === "reply") {
        const div = document.createElement("div");
        div.id = `message-${data.message_id}`;
        div.className = `chat-message ${data.sender === "{{ request.user.username }}" ? "sender" : "receiver"}`;
        div.innerHTML = `
          <div class="message-content">
            <span>${data.message}</span>
            ${data.reply_to ? `<small>(reply to "${data.reply_to_content || ""}")</small>` : ""}
          </div>
          <div class="actions">
            <i class="fas fa-ellipsis-v" onclick="toggleDropdown('${data.message_id}')"></i>
            <div class="dropdown-menu" id="dropdown-${data.message_id}" style="display: none;">
              ${data.sender === "{{ request.user.username }}" ? `
                <div class="dropdown-item" onclick="editMessage('${data.message_id}')">Edit</div>
                <div class="dropdown-item delete" onclick="deleteMessage('${data.message_id}')">Delete</div>
              ` : ""}
              <div class="dropdown-item" onclick="replyToMessage('${data.message_id}')">Reply</div>
              <div class="dropdown-item" onclick="copyMessage('${data.message}')">Copy</div>
            </div>
          </div>
        `;
        chatbox.appendChild(div);
        scrollToBottom();
        updateSidebar(data);
      } else if (data.action === "edit") {
        const messageDiv = document.getElementById(`message-${data.message_id}`);
        if (messageDiv) {
          messageDiv.querySelector(".message-content").innerHTML = `
            <span>${data.message}</span>
            <small>(edited)</small>
            ${data.reply_to ? `<small>(reply to "${data.reply_to_content || ""}")</small>` : ""}
          `;
          scrollToBottom();
        }
      } else if (data.action === "delete") {
        const messageDiv = document.getElementById(`message-${data.message_id}`);
        if (messageDiv && data.is_deleted) {
          messageDiv.remove();
          if (!chatbox.querySelector(".chat-message")) {
            chatbox.innerHTML = '<p class="no-messages">No Messages.</p>';
          }
        }
      } else if (data.action === "media") {
        const div = document.createElement("div");
        div.id = `message-${data.message_id}`;
        div.className = `chat-message ${data.sender === "{{ request.user.username }}" ? "sender" : "receiver"}`;
        let mediaContent = "";
        if (data.type === "image") mediaContent = `<img src="${data.url}" style="max-width: 200px;" />`;
        else if (data.type === "video") mediaContent = `<video controls style="max-width: 200px;"><source src="${data.url}"></video>`;
        else if (data.type === "voice") mediaContent = `<audio controls><source src="${data.url}"></audio>`;
        else if (data.type === "file") mediaContent = `<a href="${data.url}" target="_blank">${data.filename}</a>`;
        div.innerHTML = `
          <div class="message-content">${mediaContent}</div>
          <div class="actions">
            <i class="fas fa-ellipsis-v" onclick="toggleDropdown('${data.message_id}')"></i>
            <div class="dropdown-menu" id="dropdown-${data.message_id}" style="display: none;">
              ${data.sender === "{{ request.user.username }}" ? `
                <div class="dropdown-item delete" onclick="deleteMessage('${data.message_id}')">Delete</div>
              ` : ""}
              <div class="dropdown-item" onclick="replyToMessage('${data.message_id}')">Reply</div>
            </div>
          </div>
        `;
        chatbox.appendChild(div);
        scrollToBottom();
        updateSidebar(data);
      } else if (data.type === "update_chat_list") {
        fetchUpdatedChatList();
      }
    };

    function toggleDropdown(messageId) {
      const dropdown = document.getElementById(`dropdown-${messageId}`);
      dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
    }

    document.addEventListener("click", function (e) {
      if (!e.target.closest(".actions i") && !e.target.closest("#searchInput") && !e.target.closest(".search-results")) {
        document.querySelectorAll(".dropdown-menu").forEach(dropdown => {
          dropdown.style.display = "none";
        });
        document.getElementById("searchResults").style.display = "none";
      }
    });

    function editMessage(messageId) {
      const messageDiv = document.getElementById(`message-${messageId}`);
      const currentContent = messageDiv.querySelector("span").textContent;
      const newContent = prompt("Edit message:", currentContent);
      if (newContent) {
        chatSocket.send(JSON.stringify({
          action: "edit",
          message_id: messageId,
          message: newContent
        }));
      }
    }

    function deleteMessage(messageId) {
      if (confirm("Are you sure you want to delete this message?")) {
        chatSocket.send(JSON.stringify({
          action: "delete_confirm",
          message_id: messageId
        }));
      }
    }

    function replyToMessage(messageId) {
      const content = prompt("Reply:");
      if (content) {
        chatSocket.send(JSON.stringify({
          action: "reply",
          reply_to: messageId,
          message: content
        }));
      }
    }

    function copyMessage(content) {
      navigator.clipboard.writeText(content).then(() => alert("Copied!"));
    }

    function updateSidebar(data) {
      const lastMessage = document.querySelector(".list-group-item.active #last-message");
      if (lastMessage) {
        lastMessage.innerHTML = data.sender === "{{ request.user.username }}" ? "You: " + (data.message || data.type) : (data.message || data.type);
        const timestamp = document.querySelector(".list-group-item.active .timestamp");
        const date = new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
        timestamp.innerHTML = date;
      }
    }

    function fetchUpdatedChatList() {
      fetch(window.location.pathname, {
        headers: { "X-Requested-With": "XMLHttpRequest" }
      })
      .then(response => response.json())
      .then(data => {
        const contacts = document.querySelector(".contacts");
        contacts.innerHTML = data.users.map(user => `
          <a href="/chat/${user.username}/" class="list-group-item list-group-item-action ${user.username === "{{ username }}" ? "active" : ""}">
            <div class="d-flex align-items-center">
              <img src="${user.avatar_url}" class="profile-icon rounded-circle mr-3" />
              <div class="w-100">
                <div class="d-flex justify-content-between">
                  <strong class="text-truncate">${user.username}</strong>
                  <small class="text-nowrap timestamp">${user.timestamp}</small>
                </div>
                <small class="d-block text-truncate last-msg" id="last-message">
                  ${user.is_sender ? "You: " : ""}${user.last_message}
                </small>
              </div>
            </div>
          </a>
        `).join("");
      })
      .catch(error => console.error("Error fetching chat list:", error));
    }

    // Theme toggle functionality with localStorage
    const themeToggle = document.getElementById("theme-toggle");
    const container = document.querySelector(".container-fluid");

    // Sahifa yuklanganda saqlangan temani qo‘llash
    document.addEventListener("DOMContentLoaded", () => {
      const savedTheme = localStorage.getItem("theme") || "light";
      container.setAttribute("data-theme", savedTheme);
      themeToggle.innerHTML = savedTheme === "light" ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
    });

    // Tema o‘zgarganda yangi tanlovni saqlash
    themeToggle.addEventListener("click", () => {
      const currentTheme = container.getAttribute("data-theme");
      const newTheme = currentTheme === "light" ? "dark" : "light";
      container.setAttribute("data-theme", newTheme);
      localStorage.setItem("theme", newTheme);
      themeToggle.innerHTML = newTheme === "light" ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
    });

    // Search messages functionality
    function searchMessages() {
      const searchInput = document.getElementById("searchInput").value.toLowerCase();
      const searchResults = document.getElementById("searchResults");
      const messages = JSON.parse(document.getElementById("chat_messages").textContent);

      if (!searchInput) {
        searchResults.style.display = "none";
        return;
      }

      const filteredMessages = messages.filter(message => 
        message.content && message.content.toLowerCase().includes(searchInput)
      );

      if (filteredMessages.length === 0) {
        searchResults.innerHTML = '<div class="search-result">No results found</div>';
      } else {
        searchResults.innerHTML = filteredMessages.map(message => `
          <div class="search-result" onclick="highlightMessage('${message.id}')">
            ${message.content}
          </div>
        `).join("");
      }
      searchResults.style.display = "block";
    }

    function highlightMessage(messageId) {
    const messageElement = document.getElementById(`message-${messageId}`);
    if (messageElement) {
        messageElement.scrollIntoView({ behavior: "smooth", block: "center" });
        messageElement.style.backgroundColor = "rgba(255, 255, 0, 0.3)";
        setTimeout(() => {
            messageElement.style.backgroundColor = "";
        }, 2000);
    }
}
  </script>
</body>
</html>


<!-- 
<script>
  // Ensure the DOM is fully loaded
document.addEventListener("DOMContentLoaded", function() {
  const chatbox = document.querySelector("#chatbox");
  
  // Scroll to bottom function
  function scrollToBottom() {
    chatbox.scrollTop = chatbox.scrollHeight;
  }
  scrollToBottom();
  
  // WebSocket setup with error handling
  const roomName = JSON.parse(document.getElementById("room_slug").textContent);
  const wsProtocol = window.location.protocol === "https:" ? "wss://" : "ws://";
  const wsHost = window.location.host || "localhost:8000";
  let chatSocket;
  
  function connectWebSocket() {
    chatSocket = new WebSocket(`${wsProtocol}${wsHost}/ws/chat/${roomName}/`);
    
    chatSocket.onopen = function(e) {
      console.log("WebSocket connected successfully");
    };
    
    chatSocket.onerror = function(e) {
      console.error("WebSocket error:", e);
    };
    
    chatSocket.onclose = function(e) {
      console.log("WebSocket closed:", e);
      // Try to reconnect after 5 seconds if not intentionally closed
      if (!window.isPageUnloading) {
        setTimeout(connectWebSocket, 5000);
      }
    };
    
    // Handle incoming WebSocket messages
    chatSocket.onmessage = function(e) {
      const data = JSON.parse(e.data);
      console.log("Received WebSocket message:", data);
      
      if (data.action === "send" || data.action === "reply") {
        const div = document.createElement("div");
        div.id = `message-${data.message_id}`;
        div.className = `chat-message ${data.sender === username ? "sender" : "receiver"}`;
        div.innerHTML = `
          <div class="message-content">
            <span>${data.message}</span>
            ${data.reply_to ? `<small>(reply to "${data.reply_to_content || ""}")</small>` : ""}
          </div>
          <div class="actions">
            <i class="fas fa-ellipsis-v" onclick="toggleDropdown('${data.message_id}')"></i>
            <div class="dropdown-menu" id="dropdown-${data.message_id}" style="display: none;">
              ${data.sender === username ? `
                <div class="dropdown-item" onclick="editMessage('${data.message_id}')">Edit</div>
                <div class="dropdown-item delete" onclick="deleteMessage('${data.message_id}')">Delete</div>
              ` : ""}
              <div class="dropdown-item" onclick="replyToMessage('${data.message_id}')">Reply</div>
              <div class="dropdown-item" onclick="copyMessage('${data.message}')">Copy</div>
            </div>
          </div>
        `;
        chatbox.appendChild(div);
        scrollToBottom();
        updateSidebar(data);
      } else if (data.action === "edit") {
        const messageDiv = document.getElementById(`message-${data.message_id}`);
        if (messageDiv) {
          messageDiv.querySelector(".message-content").innerHTML = `
            <span>${data.message}</span>
            <small>(edited)</small>
            ${data.reply_to ? `<small>(reply to "${data.reply_to_content || ""}")</small>` : ""}
          `;
          scrollToBottom();
        }
      } else if (data.action === "delete") {
        const messageDiv = document.getElementById(`message-${data.message_id}`);
        if (messageDiv && data.is_deleted) {
          messageDiv.remove();
          if (!chatbox.querySelector(".chat-message")) {
            chatbox.innerHTML = '<p class="no-messages">No Messages.</p>';
          }
        }
      } else if (data.action === "media") {
        const div = document.createElement("div");
        div.id = `message-${data.message_id}`;
        div.className = `chat-message ${data.sender === username ? "sender" : "receiver"}`;
        
        let mediaContent = "";
        if (data.type === "image") mediaContent = `<img src="${data.url}" style="max-width: 200px;" />`;
        else if (data.type === "video") mediaContent = `<video controls style="max-width: 200px;"><source src="${data.url}"></video>`;
        else if (data.type === "voice") mediaContent = `<audio controls><source src="${data.url}"></audio>`;
        else if (data.type === "file") mediaContent = `<a href="${data.url}" target="_blank">${data.filename}</a>`;
        
        div.innerHTML = `
          <div class="message-content">${mediaContent}</div>
          <div class="actions">
            <i class="fas fa-ellipsis-v" onclick="toggleDropdown('${data.message_id}')"></i>
            <div class="dropdown-menu" id="dropdown-${data.message_id}" style="display: none;">
              ${data.sender === username ? `
                <div class="dropdown-item delete" onclick="deleteMessage('${data.message_id}')">Delete</div>
              ` : ""}
              <div class="dropdown-item" onclick="replyToMessage('${data.message_id}')">Reply</div>
            </div>
          </div>
        `;
        chatbox.appendChild(div);
        scrollToBottom();
        updateSidebar(data);
      } else if (data.type === "update_chat_list") {
        fetchUpdatedChatList();
      }
    };
  }
  
  connectWebSocket();
  
  // Save username for later use
  const username = document.querySelector(".username").textContent || '';
  
  // Flag to prevent reconnect attempts when page is unloading
  window.isPageUnloading = false;
  window.onbeforeunload = function() {
    window.isPageUnloading = true;
    if (chatSocket) {
      chatSocket.close();
    }
  };
  
  // Text message handling
  const messageInput = document.querySelector("#my_input");
  const submitButton = document.querySelector("#submit_button");
  
  messageInput.focus();
  messageInput.onkeyup = function(e) {
    if (e.keyCode === 13) {  // Enter key
      e.preventDefault();
      submitButton.click();
    }
  };
  
  submitButton.onclick = function(e) {
    const messageText = messageInput.value.trim();
    if (!messageText) {
      return;  // Don't send empty messages
    }
    
    console.log("Sending message:", messageText);
    chatSocket.send(JSON.stringify({
      action: "send",
      message: messageText
    }));
    
    messageInput.value = "";
    messageInput.focus();
  };
  
  // Media file upload handling
  const mediaInput = document.querySelector("#mediaInput");
  
  mediaInput.addEventListener("change", function(e) {
    const files = e.target.files;
    if (files.length === 0) return;
    
    // Create loading indicator
    const loadingDiv = document.createElement("div");
    loadingDiv.className = "chat-message sender";
    loadingDiv.innerHTML = `<div class="message-content">Uploading file(s)... <i class="fas fa-spinner fa-spin"></i></div>`;
    chatbox.appendChild(loadingDiv);
    scrollToBottom();
    
    let completedUploads = 0;
    const totalFiles = files.length;
    
    for (let file of files) {
      // Determine file type
      let fileType;
      if (file.type.startsWith("image/")) fileType = "image";
      else if (file.type.startsWith("video/")) fileType = "video";
      else if (file.type.startsWith("audio/")) fileType = "voice";
      else fileType = "file";
      
      const formData = new FormData();
      formData.append("file", file);
      formData.append("action", "media");
      formData.append("type", fileType);
      
      // Send to server
      fetch("/upload-media/", {
        method: "POST",
        body: formData,
        headers: { "X-CSRFToken": getCookie("csrftoken") }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        console.log("File uploaded:", data);
        
        // Send WebSocket message about uploaded file
        chatSocket.send(JSON.stringify({
          action: "media",
          type: fileType,
          url: data.url,
          filename: file.name
        }));
        
        completedUploads++;
        if (completedUploads === totalFiles) {
          // Remove loading indicator
          loadingDiv.remove();
        }
      })
      .catch(error => {
        console.error("Error uploading file:", error);
        loadingDiv.innerHTML = `<div class="message-content">Error uploading file: ${error.message}</div>`;
        
        completedUploads++;
        if (completedUploads === totalFiles) {
          // Remove loading indicator after delay
          setTimeout(() => loadingDiv.remove(), 5000);
        }
      });
    }
    
    // Reset file input
    mediaInput.value = "";
  });
  
  // Voice recording functionality
  const voiceButton = document.querySelector("#voiceButton");
  let mediaRecorder;
  let audioChunks = [];
  let recordingTimeout;
  
  voiceButton.addEventListener("click", async function() {
    if (!mediaRecorder || mediaRecorder.state === "inactive") {
      try {
        // Request microphone access
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        // Create media recorder
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        
        // Start recording
        mediaRecorder.start();
        voiceButton.innerHTML = '<i class="fas fa-stop"></i>';
        voiceButton.classList.add("recording");
        
        // Add recording indicator to chat
        const recordingDiv = document.createElement("div");
        recordingDiv.id = "recording-indicator";
        recordingDiv.className = "chat-message sender recording-message";
        recordingDiv.innerHTML = `<div class="message-content">Recording... <span id="recording-time">0:00</span></div>`;
        chatbox.appendChild(recordingDiv);
        scrollToBottom();
        
        // Start recording timer
        let seconds = 0;
        const timerElement = document.getElementById("recording-time");
        const recordingTimer = setInterval(() => {
          seconds++;
          const minutes = Math.floor(seconds / 60);
          const remainingSeconds = seconds % 60;
          timerElement.textContent = `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }, 1000);
        
        // Set maximum recording time (2 minutes)
        recordingTimeout = setTimeout(() => {
          if (mediaRecorder && mediaRecorder.state === "recording") {
            mediaRecorder.stop();
            clearInterval(recordingTimer);
          }
        }, 120000);
        
        // Handle data available event
        mediaRecorder.ondataavailable = (event) => {
          audioChunks.push(event.data);
        };
        
        // Handle recording stop
        mediaRecorder.onstop = () => {
          // Clean up UI
          clearTimeout(recordingTimeout);
          clearInterval(recordingTimer);
          voiceButton.innerHTML = '<i class="fas fa-microphone"></i>';
          voiceButton.classList.remove("recording");
          const recordingIndicator = document.getElementById("recording-indicator");
          if (recordingIndicator) {
            recordingIndicator.innerHTML = `<div class="message-content">Processing voice message... <i class="fas fa-spinner fa-spin"></i></div>`;
          }
          
          // Stop all tracks in the stream
          stream.getTracks().forEach(track => track.stop());
          
          // Create audio blob
          const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
          
          // If recording is too short, show error
          if (audioBlob.size < 1000) {
            if (recordingIndicator) {
              recordingIndicator.innerHTML = `<div class="message-content">Recording too short</div>`;
              setTimeout(() => recordingIndicator.remove(), 2000);
            }
            return;
          }
          
          // Upload audio blob
          const formData = new FormData();
          formData.append("file", audioBlob, "voice-message.webm");
          formData.append("action", "media");
          formData.append("type", "voice");
          
          fetch("/upload-media/", {
            method: "POST",
            body: formData,
            headers: { "X-CSRFToken": getCookie("csrftoken") }
          })
          .then(response => {
            if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
            return response.json();
          })
          .then(data => {
            // Remove indicator
            if (recordingIndicator) recordingIndicator.remove();
            
            // Send WebSocket message
            chatSocket.send(JSON.stringify({
              action: "media",
              type: "voice",
              url: data.url,
              filename: "voice-message.webm"
            }));
          })
          .catch(error => {
            console.error("Error uploading voice:", error);
            if (recordingIndicator) {
              recordingIndicator.innerHTML = `<div class="message-content">Error uploading voice: ${error.message}</div>`;
              setTimeout(() => recordingIndicator.remove(), 5000);
            }
          });
        };
      } catch (err) {
        console.error("Microphone access error:", err);
        alert("Please allow microphone access to record voice messages.");
      }
    } else {
      // Stop recording
      mediaRecorder.stop();
    }
  });
  
  // Define utility functions in global scope for onClick handlers
  window.toggleDropdown = function(messageId) {
    const dropdown = document.getElementById(`dropdown-${messageId}`);
    dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
  };
  
  window.editMessage = function(messageId) {
    const messageDiv = document.getElementById(`message-${messageId}`);
    const currentContent = messageDiv.querySelector("span").textContent;
    const newContent = prompt("Edit message:", currentContent);
    if (newContent && newContent !== currentContent) {
      chatSocket.send(JSON.stringify({
        action: "edit",
        message_id: messageId,
        message: newContent
      }));
    }
  };
  
  window.deleteMessage = function(messageId) {
    if (confirm("Are you sure you want to delete this message?")) {
      chatSocket.send(JSON.stringify({
        action: "delete_confirm",
        message_id: messageId
      }));
    }
  };
  
  window.replyToMessage = function(messageId) {
    const content = prompt("Reply:");
    if (content) {
      chatSocket.send(JSON.stringify({
        action: "reply",
        reply_to: messageId,
        message: content
      }));
    }
  };
  
  window.copyMessage = function(content) {
    navigator.clipboard.writeText(content)
      .then(() => {
        const toast = document.createElement("div");
        toast.className = "toast-notification";
        toast.textContent = "Message copied!";
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 2000);
      })
      .catch(() => alert("Failed to copy message"));
  };
  
  window.highlightMessage = function(messageId) {
    const messageElement = document.getElementById(`message-${messageId}`);
    if (messageElement) {
      messageElement.scrollIntoView({ behavior: "smooth", block: "center" });
      messageElement.style.backgroundColor = "rgba(255, 255, 0, 0.3)";
      setTimeout(() => {
        messageElement.style.backgroundColor = "";
      }, 2000);
    }
  };
  
  // Document click handler to close dropdowns
  document.addEventListener("click", function(e) {
    if (!e.target.closest(".actions i") && !e.target.closest("#searchInput") && !e.target.closest(".search-results")) {
      document.querySelectorAll(".dropdown-menu").forEach(dropdown => {
        dropdown.style.display = "none";
      });
      document.getElementById("searchResults").style.display = "none";
    }
  });
  
  // Helper to get CSRF token from cookies
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  
  // Update sidebar with latest message
  function updateSidebar(data) {
    const lastMessage = document.querySelector(".list-group-item.active #last-message");
    if (lastMessage) {
      const messageContent = data.message || 
                          (data.type === "image" ? "Photo" : 
                           data.type === "video" ? "Video" : 
                           data.type === "voice" ? "Voice message" : 
                           data.type === "file" ? "File" : "");
      
      lastMessage.innerHTML = data.sender === username ? "You: " + messageContent : messageContent;
      
      const timestamp = document.querySelector(".list-group-item.active .timestamp");
      const date = new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
      timestamp.innerHTML = date;
    }
  }
  
  // Fetch updated chat list
  function fetchUpdatedChatList() {
    fetch(window.location.pathname, {
      headers: { "X-Requested-With": "XMLHttpRequest" }
    })
    .then(response => response.json())
    .then(data => {
      const contacts = document.querySelector(".contacts");
      contacts.innerHTML = data.users.map(user => `
        <a href="/chat/${user.username}/" class="list-group-item list-group-item-action ${user.username === roomName ? "active" : ""}">
          <div class="d-flex align-items-center">
            <img src="${user.avatar_url}" class="profile-icon rounded-circle mr-3" />
            <div class="w-100">
              <div class="d-flex justify-content-between">
                <strong class="text-truncate">${user.username}</strong>
                <small class="text-nowrap timestamp">${user.timestamp}</small>
              </div>
              <small class="d-block text-truncate last-msg" id="last-message">
                ${user.is_sender ? "You: " : ""}${user.last_message}
              </small>
            </div>
          </div>
        </a>
      `).join("");
    })
    .catch(error => console.error("Error fetching chat list:", error));
  }
  
  // Search messages functionality
  const searchInput = document.getElementById("searchInput");
  if (searchInput) {
    searchInput.addEventListener("input", searchMessages);
  }
  
  function searchMessages() {
    const searchInput = document.getElementById("searchInput").value.toLowerCase();
    const searchResults = document.getElementById("searchResults");
    const messages = JSON.parse(document.getElementById("chat_messages").textContent);
    
    if (!searchInput) {
      searchResults.style.display = "none";
      return;
    }
    
    const filteredMessages = messages.filter(message => 
      message.content && message.content.toLowerCase().includes(searchInput)
    );
    
    if (filteredMessages.length === 0) {
      searchResults.innerHTML = '<div class="search-result">No results found</div>';
    } else {
      searchResults.innerHTML = filteredMessages.map(message => `
        <div class="search-result" onclick="highlightMessage('${message.id}')">
          ${message.content}
        </div>
      `).join("");
    }
    
    searchResults.style.display = "block";
  }
  
  // Theme toggle functionality with localStorage
  const themeToggle = document.getElementById("theme-toggle");
  const container = document.querySelector(".container-fluid");
  
  // Apply saved theme on page load
  const savedTheme = localStorage.getItem("theme") || "light";
  container.setAttribute("data-theme", savedTheme);
  themeToggle.innerHTML = savedTheme === "light" ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
  
  // Toggle theme on click
  themeToggle.addEventListener("click", () => {
    const currentTheme = container.getAttribute("data-theme");
    const newTheme = currentTheme === "light" ? "dark" : "light";
    container.setAttribute("data-theme", newTheme);
    localStorage.setItem("theme", newTheme);
    themeToggle.innerHTML = newTheme === "light" ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
  });
  
  // Add custom CSS for better UI feedback
  const style = document.createElement('style');
  style.textContent = `
    .recording-message {
      background-color: rgba(255, 0, 0, 0.1);
    }
    
    #voiceButton.recording {
      background-color: #ff4444;
      color: white;
    }
    
    .toast-notification {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 10px 20px;
      border-radius: 4px;
      z-index: 1000;
    }
    
    .dropdown-item {
      cursor: pointer;
    }
    
    .dropdown-item.delete {
      color: #dc3545;
    }
    
    .dropdown-item:hover {
      background-color: #f8f9fa;
    }
  `;
  document.head.appendChild(style);
});
</script>

<style>
  /* Base styles */
html, body {
  height: 100%;
  margin: 0;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.container-fluid {
  height: 100%;
  padding: 0;
  transition: background-color 0.3s ease;
}

/* Theme colors */
[data-theme="light"] {
  --bg-color: #f8f9fa;
  --sidebar-bg: #ffffff;
  --chat-bg: #e9eaed;
  --header-bg: #ffffff;
  --input-bg: #ffffff;
  --text-color: #212529;
  --secondary-text: #6c757d;
  --border-color: #dee2e6;
  --message-sender-bg: #dcf8c6;
  --message-receiver-bg: #ffffff;
  --hover-color: rgba(0, 0, 0, 0.05);
  --active-color: rgba(0, 0, 0, 0.1);
}

[data-theme="dark"] {
  --bg-color: #222;
  --sidebar-bg: #333;
  --chat-bg: #222;
  --header-bg: #333;
  --input-bg: #444;
  --text-color: #fff;
  --secondary-text: #aaa;
  --border-color: #555;
  --message-sender-bg: #056162;
  --message-receiver-bg: #262d31;
  --hover-color: rgba(255, 255, 255, 0.1);
  --active-color: rgba(255, 255, 255, 0.2);
}

/* Apply theme colors */
.container-fluid {
  background-color: var(--bg-color);
  color: var(--text-color);
}

.sidebar {
  background-color: var(--sidebar-bg);
  border-right: 1px solid var(--border-color);
}

.chat {
  background-color: var(--chat-bg);
}

.header-bar {
  background-color: var(--header-bg);
  border-bottom: 1px solid var(--border-color);
}

.chat-input {
  background-color: var(--header-bg);
  border-top: 1px solid var(--border-color);
}

input, .form-control {
  background-color: var(--input-bg) !important;
  color: var(--text-color) !important;
  border-color: var(--border-color) !important;
}

input::placeholder {
  color: var(--secondary-text) !important;
}

/* Sidebar styles */
.sidebar {
  display: flex;
  flex-direction: column;
  height: 100%;
  overflow-y: auto;
}

.contacts {
  flex-grow: 1;
  overflow-y: auto;
}

.list-group-item {
  border: none;
  border-radius: 0;
  margin-bottom: 1px;
  background-color: transparent;
  transition: all 0.2s ease;
}

.list-group-item:hover {
  background-color: var(--hover-color);
}

.list-group-item.active {
  background-color: var(--active-color);
  color: var(--text-color);
  border-color: transparent;
}

.profile-icon {
  width: 40px;
  height: 40px;
  object-fit: cover;
}

.timestamp {
  color: var(--secondary-text);
}

.last-msg {
  color: var(--secondary-text);
}

.logout {
  padding: 10px;
  border-top: 1px solid var(--border-color);
}

/* Chat area */
.chat {
  height: 100%;
}

.header-bar {
  padding: 10px 15px;
  height: 60px;
}

.header-bar h3 {
  margin: 0;
  font-size: 18px;
}

.header-bar a {
  color: var(--text-color);
  text-decoration: none;
}

.chatbox {
  height: calc(100% - 130px);
  overflow-y: auto;
  padding: 15px;
  background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" opacity="0.05"><rect width="100" height="100" fill="%23FFFFFF"/><rect x="100" y="100" width="100" height="100" fill="%23FFFFFF"/></svg>');
  background-size: 20px;
}

/* Messages */
.chat-message {
  display: flex;
  align-items: flex-start;
  margin-bottom: 10px;
  position: relative;
  max-width: 80%;
  word-wrap: break-word;
}

.sender {
  margin-left: auto;
  flex-direction: row-reverse;
}

.message-content {
  padding: 8px 12px;
  border-radius: 10px;
  position: relative;
  max-width: 100%;
}

.sender .message-content {
  background-color: var(--message-sender-bg);
  border-top-right-radius: 0;
  margin-right: 5px;
}

.receiver .message-content {
  background-color: var(--message-receiver-bg);
  border-top-left-radius: 0;
  margin-left: 5px;
}

.actions {
  margin: 0 5px;
  display: flex;
  align-items: center;
  cursor: pointer;
  position: relative;
}

.fas.fa-ellipsis-v {
  padding: 5px;
  font-size: 12px;
  opacity: 0.5;
  transition: opacity 0.2s;
}

.fas.fa-ellipsis-v:hover {
  opacity: 1;
}

.dropdown-menu {
  position: absolute;
  background-color: var(--sidebar-bg);
  border: 1px solid var(--border-color);
  border-radius: 5px;
  top: 100%;
  right: 0;
  z-index: 100;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
  padding: 0;
  min-width: 120px;
}

.sender .dropdown-menu {
  left: 0;
  right: auto;
}

.dropdown-item {
  padding: 10px 15px;
  color: var(--text-color);
  font-size: 14px;
  cursor: pointer;
  border-bottom: 1px solid var(--border-color);
}

.dropdown-item:last-child {
  border-bottom: none;
}

.dropdown-item:hover {
  background-color: var(--hover-color);
}

/* Input area */
.chat-input {
  padding: 10px 15px;
  height: 70px;
}

.input-group {
  background-color: var(--input-bg);
  border-radius: 20px;
}

.btn-outline-secondary {
  color: var(--secondary-text);
  border-color: var(--border-color);
}

.btn-primary {
  background-color: #0d6efd;
  border-color: #0d6efd;
}

/* Audio/video controls */
audio, video {
  max-width: 100%;
  border-radius: 8px;
}

/* Search results */
.search-results {
  position: absolute;
  top: 100%;
  right: 0}
</style> -->